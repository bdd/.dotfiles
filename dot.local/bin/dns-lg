#!/usr/bin/env bash
set -euo pipefail

DNSLG='http://www.dns-lg.com'
anycast_nodes=(google1 google2 opendns1 opendns2 cloudflare quad9 he)
default_nodes=(google1 cloudflare quad9 opendns1)

usage() {
  echo "usage: $(basename "${0}") [-Aau] name [rrtype] ..." >&2
  exit 64 # EX_USAGE
}

nodes=()
OPTIND=1
while getopts ':Aau' opt; do
  case "${opt}" in
    a)
      nodes+=("${anycast_nodes[@]}")
      ;;
    u)
      readarray -tO "${#nodes[@]}" nodes < <(
        if ! { curl -sf "${DNSLG}/nodes.json" | jq -r '.nodes[].name'; }; then
          echo "WARN: Failed to fetch unicast node list" >&2
        fi
      )
      ;;
    *)
      echo "Unrecognized option -${OPTARG}" >&2
      usage
      ;;
  esac
done
shift $((OPTIND - 1))

# In case no '-a' or '-u' flag passed, use the default node list.
[[ -z ${nodes[*]} ]] && nodes=("${default_nodes[@]}")

# Need a name to resolve
[[ $1 ]] || usage
name=$1
shift

# In case no rrtypes are passed, by default resolve IPv4 and IPv6 addrs.
(( $# )) && rrtypes=("$@") || rrtypes=(A AAAA)

if ! hash jq 2>/dev/null; then
  echo "jq: not found" >&2
  exit 69 # EX_UNAVAILABLE
fi

for node in "${nodes[@]}"; do
  echo "> ${node}:"
  for rrtype in "${rrtypes[@]}"; do
    if ! {
      curl -sf "${DNSLG}/${node}/${name}/${rrtype}" \
        | jq -r '[.answer[].rdata] | sort[]' 2>/dev/null
    }
    then
      echo "<failed>"
    fi
  done
done
